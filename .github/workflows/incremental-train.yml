name: 🔄 Incremental Training

on:
  push:
    branches: [ main ]
    paths:
      - 'datasets/**/*.jsonl'
      - 'scripts/**/*.py'
  schedule:
    - cron: '30 4 * * *'
  workflow_dispatch:
    inputs:
      date:
        description: 'Date (YYYY-MM-DD)'
        required: false
        type: string
      replay_size:
        description: 'Replay size'
        required: false
        default: '800'
        type: string
      gate_drop:
        description: 'Max allowed F1 drop'
        required: false
        default: '0.01'
        type: string
      push_to_hub:
        description: 'Push models to HF Hub'
        default: false
        type: boolean
      merge_lora:
        description: 'Push full model (merge LoRA)'
        default: false
        type: boolean

concurrency:
  group: incremental-training
  cancel-in-progress: false

permissions:
  contents: write
  actions: read

env:
  PYTHON_VERSION: '3.11'
  HF_REPO_SENTIMENT: 'Bencode92/tradepulse-finbert-sentiment'
  HF_REPO_IMPORTANCE: 'Bencode92/tradepulse-finbert-importance'
  HF_TOKEN: ${{ secrets.HF_TOKEN }}

jobs:
  incremental-train:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: 📦 Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-ml.txt
          pip install peft accelerate
      
      - name: 📅 Set date
        id: date
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            echo "date=${{ github.event.inputs.date }}" >> $GITHUB_OUTPUT
          else
            echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          fi
      
      - name: 📥 Collect yesterday's data
        run: |
          python scripts/collect_news.py \
            --source mixed \
            --count 100 \
            --days 1 \
            --output "datasets/daily_$(date +%Y%m%d).jsonl" \
            --format jsonl \
            --auto-label \
            --ml-model production
      
      - name: 🔀 Prepare replay buffer
        run: |
          REPLAY_SIZE="${{ github.event.inputs.replay_size || '800' }}"
          python scripts/prepare_replay.py \
            --date "${{ steps.date.outputs.date }}" \
            --replay-size "$REPLAY_SIZE" \
            --output "datasets/combined.jsonl"
      
      - name: 🎯 Train sentiment (LoRA)
        run: |
          GATE="${{ github.event.inputs.gate_drop || '0.01' }}"
          HF_REPO=""
          MERGE=""
          if [ "${{ github.event.inputs.push_to_hub }}" = "true" ]; then HF_REPO="${{ env.HF_REPO_SENTIMENT }}"; fi
          if [ "${{ github.event.inputs.merge_lora }}" = "true" ]; then MERGE="--merge_lora"; fi
          python scripts/finetune_incremental.py \
            --task sentiment --incremental \
            --model "distilbert-base-uncased" \
            --dataset "datasets/combined.jsonl" \
            --output_dir "outputs/incremental" \
            --epochs 1 --batch_size 4 --learning_rate 5e-5 \
            --gate_drop "$GATE" \
            --hf_repo "$HF_REPO" \
            --hf_token "${{ env.HF_TOKEN }}" $MERGE
      
      - name: 📊 Train importance (LoRA)
        run: |
          GATE="${{ github.event.inputs.gate_drop || '0.01' }}"
          HF_REPO=""
          MERGE=""
          if [ "${{ github.event.inputs.push_to_hub }}" = "true" ]; then HF_REPO="${{ env.HF_REPO_IMPORTANCE }}"; fi
          if [ "${{ github.event.inputs.merge_lora }}" = "true" ]; then MERGE="--merge_lora"; fi
          python scripts/finetune_incremental.py \
            --task importance --incremental \
            --model "distilbert-base-uncased" \
            --dataset "datasets/combined.jsonl" \
            --output_dir "outputs/incremental" \
            --epochs 1 --batch_size 4 --learning_rate 5e-5 \
            --gate_drop "$GATE" \
            --hf_repo "$HF_REPO" \
            --hf_token "${{ env.HF_TOKEN }}" $MERGE
      
      - name: 💾 Save metrics as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: training-metrics-${{ steps.date.outputs.date }}
          path: |
            outputs/incremental/**/metrics.json
            outputs/last_metrics.json.*
          retention-days: 30
      
      - name: 📝 Commit updated datasets
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add datasets/*.jsonl
          git diff --staged --quiet || git commit -m "📊 Add daily dataset and replay buffer for ${{ steps.date.outputs.date }}"
          git push
