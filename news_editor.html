<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TradePulse ‚Äì √âditeur & GitHub Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
      /* Styles pour le multi-select des corr√©lations */
      .correlation-dropdown {
        position: relative;
        display: inline-block;
      }
      
      .correlation-dropdown-content {
        display: none;
        position: absolute;
        background-color: rgba(30, 41, 59, 0.95);
        min-width: 360px;
        max-height: 420px;
        overflow-y: auto;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1000;
        border: 1px solid rgba(147, 51, 234, 0.3);
        border-radius: 0.5rem;
        backdrop-filter: blur(10px);
      }
      
      .correlation-dropdown.active .correlation-dropdown-content {
        display: block;
      }
      
      .correlation-option {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s;
      }
      
      .correlation-option:hover {
        background-color: rgba(147, 51, 234, 0.2);
      }
      
      .correlation-option.selected {
        background-color: rgba(147, 51, 234, 0.3);
      }
      
      .correlation-checkbox {
        width: 16px;
        height: 16px;
        accent-color: #a855f7;
      }
      
      .correlation-dropdown-button {
        padding: 6px 12px;
        background-color: rgba(147, 51, 234, 0.2);
        border: 1px solid rgba(147, 51, 234, 0.5);
        color: #d8b4fe;
        cursor: pointer;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        transition: all 0.2s;
      }
      
      .correlation-dropdown-button:hover {
        background-color: rgba(147, 51, 234, 0.3);
        transform: translateY(-1px);
      }
      
      /* Scrollbar styling */
      .correlation-dropdown-content::-webkit-scrollbar {
        width: 8px;
      }
      
      .correlation-dropdown-content::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
      }
      
      .correlation-dropdown-content::-webkit-scrollbar-thumb {
        background: rgba(147, 51, 234, 0.5);
        border-radius: 4px;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4">
    <div class="max-w-7xl mx-auto space-y-6">
      <!-- Header avec debug info -->
      <div class="text-center py-8">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
          üì∞ TradePulse
        </h1>
        <p class="text-xl text-gray-300 mt-2">News Dataset Editor & GitHub Sync</p>
        <div id="debugInfo" class="text-sm text-yellow-400 mt-2 bg-black/20 p-2 rounded"></div>
      </div>

      <!-- GitHub config -->
      <details class="bg-white/10 backdrop-blur-lg rounded-xl shadow-2xl border border-white/20 p-6">
        <summary class="cursor-pointer text-lg font-medium select-none text-white flex items-center gap-2">
          <span class="text-2xl">üîß</span> Connexion GitHub
          <span class="ml-auto text-sm text-gray-300">(optionnel)</span>
        </summary>
        <div class="grid md:grid-cols-4 gap-4 mt-6">
          <div class="col-span-2">
            <label class="block text-sm font-medium mb-2 text-gray-200">Repository (owner/nom)</label>
            <input id="ghRepo" type="text" placeholder="Bencode92/tradepulse-ml" 
                   class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 backdrop-blur-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-200">Branch</label>
            <input id="ghBranch" type="text" value="main" 
                   class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white backdrop-blur-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2 text-gray-200">Token (scope repo)</label>
            <input id="ghToken" type="password" placeholder="ghp_..."
                   class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 backdrop-blur-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
        </div>
        <div class="flex flex-wrap gap-4 mt-6">
          <button id="loadGithubBtn" class="px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105">
            üì• Charger dernier CSV GitHub
          </button>
          <button id="pushGithubBtn" class="px-6 py-3 bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105" disabled>
            üì§ Commit vers GitHub
          </button>
          <button id="triggerWorkflowBtn" class="px-6 py-3 bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105" disabled>
            üöÄ D√©clencher Fine-tuning
          </button>
          <span id="ghStatus" class="text-sm text-gray-300 flex items-center"></span>
        </div>
      </details>

      <!-- Actions bar -->
      <div class="flex flex-wrap gap-4 items-center bg-white/10 backdrop-blur-lg p-6 rounded-xl shadow-2xl border border-white/20">
        <label class="inline-flex items-center gap-2 cursor-pointer">
          <input id="fileInput" type="file" accept=".csv" class="hidden" />
          <span class="px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105">
            üìÅ Importer CSV local
          </span>
        </label>
        <button id="addRowBtn" class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105" disabled>
          ‚ûï Ajouter ligne
        </button>
        <button id="validateBtn" class="px-6 py-3 bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 text-white rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105" disabled>
          ‚úÖ Valider donn√©es
        </button>
        <button id="downloadBtn" class="px-6 py-3 bg-gradient-to-r from-pink-500 to-rose-600 hover:from-pink-600 hover:to-rose-700 text-white rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105" disabled>
          üíæ T√©l√©charger CSV
        </button>
        <span id="status" class="text-sm text-gray-300 ml-auto flex items-center"></span>
      </div>

      <!-- Statistiques AVEC CORR√âLATIONS -->
      <div id="statsPanel" class="hidden grid md:grid-cols-8 gap-4">
        <div class="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
          <div class="text-2xl font-bold text-blue-400" id="totalRows">0</div>
          <div class="text-sm text-gray-300">Total lignes</div>
        </div>
        <!-- Stats sentiment -->
        <div class="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
          <div class="text-2xl font-bold text-green-400" id="positiveCount">0</div>
          <div class="text-sm text-gray-300">Positifs</div>
        </div>
        <div class="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
          <div class="text-2xl font-bold text-red-400" id="negativeCount">0</div>
          <div class="text-sm text-gray-300">N√©gatifs</div>
        </div>
        <div class="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
          <div class="text-2xl font-bold text-gray-400" id="neutralCount">0</div>
          <div class="text-sm text-gray-300">Neutres</div>
        </div>
        <!-- Stats importance -->
        <div class="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
          <div class="text-2xl font-bold text-red-400" id="critiqueCount">0</div>
          <div class="text-sm text-gray-300">Critiques</div>
        </div>
        <div class="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
          <div class="text-2xl font-bold text-yellow-400" id="importanteCount">0</div>
          <div class="text-sm text-gray-300">Importantes</div>
        </div>
        <div class="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
          <div class="text-2xl font-bold text-green-400" id="g√©n√©raleCount">0</div>
          <div class="text-sm text-gray-300">G√©n√©rales</div>
        </div>
        <!-- Stats corr√©lations -->
        <div class="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
          <div class="text-2xl font-bold text-purple-400" id="correlationCount">0</div>
          <div class="text-sm text-gray-300">Corr√©lations</div>
        </div>
      </div>

      <!-- Table container -->
      <div id="tableWrapper" class="overflow-x-auto rounded-xl shadow-2xl bg-white/10 backdrop-blur-lg border border-white/20"></div>

      <!-- Messages de validation -->
      <div id="validationResults" class="hidden bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
        <h3 class="text-lg font-medium text-white mb-4">üîç R√©sultats de validation</h3>
        <div id="validationContent" class="text-gray-300"></div>
      </div>
    </div>

    <script>
      // Liste compl√®te des corr√©lations possibles (R√âDUITE de 83 √† 59)
      const ALL_CORRELATIONS = [
        "AU:IRON_ORE", "AU:WHEAT", "AU:NATGAS",
        "BR:COFFEE", "BR:SOYBEANS", "BR:SUGAR", "BR:IRON_ORE", "BR:MEAT",
        "CA:WHEAT", "CA:NICKEL", "CA:ALUMINIUM",
        "CD:COPPER_REFINED",
        "CH:GOLD", "CH:PHARMACEUTICALS",
        "CL:COPPER_ORE", "CL:COPPER_REFINED",
        "CN:APPAREL", "CN:MACHINERY", "CN:ELECTRICAL_MACHINERY", "CN:SILVER", "CN:NICKEL", 
        "CN:CHEMICALS_ORGANIC", "CN:PLASTICS", "CN:VEHICLES", "CN:OPTICAL_INSTRUMENTS",
        "DE:COCOA", "DE:PHARMACEUTICALS", "DE:VEHICLES", "DE:AIRCRAFT", "DE:OPTICAL_INSTRUMENTS",
        "FR:AIRCRAFT", "FR:ELECTRICITY", "FR:BEVERAGES", "FR:FINANCIAL_SERVICES",
        "GB:SILVER", "GB:GOLD",
        "HK:SILVER", "HK:ELECTRICAL_MACHINERY",
        "ID:PALM_OIL",
        "IN:IT_SERVICES",
        "KZ:URANIUM",
        "LU:FINANCIAL_SERVICES",
        "MY:PALM_OIL",
        "NL:COCOA",
        "NO:NATGAS", "NO:NICKEL", "NO:FISH",
        "PE:COPPER_ORE",
        "RU:PETROLEUM_CRUDE",
        "SG:FINANCIAL_SERVICES",
        "AE:PETROLEUM_CRUDE",
        "US:SOYBEANS", "US:WHEAT", "US:PETROLEUM_CRUDE", "US:NATGAS", "US:MEAT",
        "US:CHEMICALS_ORGANIC", "US:PHARMACEUTICALS", "US:PLASTICS", 
        "US:OPTICAL_INSTRUMENTS", "US:TRAVEL"
      ];

      // Mapping des codes produits vers labels fran√ßais
      const PRODUCT_LABELS = {
        "DIAMONDS": "Diamants", "PETROLEUM_CRUDE": "P√©trole brut", "CORN": "Ma√Øs", 
        "ALUMINIUM_ORE": "Minerai d'aluminium", "COAL": "Charbon", "IRON_ORE": "Minerai de fer",
        "NATGAS": "Gaz naturel", "WHEAT": "Bl√©", "ZINC_ORE": "Minerai de zinc",
        "ZINC_METAL": "Zinc brut", "COFFEE": "Caf√©", "MEAT": "Viande", "SOYBEAN": "Soja",
        "SUGAR": "Sucre", "ALUMINIUM_METAL": "Aluminium brut", "NICKEL_METAL": "Nickel brut",
        "COPPER_REFINED": "Cuivre raffin√©", "GOLD": "Or", "PHARMACEUTICALS": "Produits pharmaceutiques",
        "COPPER_ORE": "Minerai de cuivre", "COPPER_UNREFINED": "Cuivre non raffin√©",
        "APPAREL": "V√™tements", "CARBON": "Carbone", "CHEMICALS_MISC": "Produits chimiques divers",
        "CHEMICALS_ORGANIC": "Produits chimiques organiques", "ELECTRICAL_MACHINERY": "Machines √©lectriques",
        "FURNITURE": "Meubles", "MACHINERY": "Machines", "OPTICAL_INSTRUMENTS": "Instruments optiques",
        "PAPER": "Papier", "PLASTICS": "Plastiques", "RARE_GASES": "Gaz rares", "RUBBER": "Caoutchouc",
        "SHIPS": "Navires", "SILVER": "Argent", "TOYS": "Jouets", "VEHICLES": "V√©hicules",
        "WOOD": "Bois", "AIRCRAFT": "A√©ronefs", "COCOA": "Cacao", "FINANCIAL_SERVICES": "Services financiers",
        "NICKEL_ORE": "Minerai de nickel", "BEVERAGES": "Boissons", "COSMETICS": "Cosm√©tiques",
        "ELECTRICITY": "√âlectricit√©", "PLATINUM": "Platine", "FERROALLOYS": "Ferro-alliages",
        "PALM_OIL": "Huile de palme", "TIN": "√âtain", "IT_SERVICES": "Services informatiques",
        "RICE": "Riz", "URANIUM": "Uranium", "LEAD_ORE": "Minerai de plomb",
        "PRECIOUS_METALS_ORE": "Minerais de m√©taux pr√©cieux", "FISH": "Poisson",
        "PETROLEUM_REFINED": "P√©trole raffin√©", "EDIBLE_FRUITS": "Fruits comestibles",
        "TRAVEL": "Services de voyage", "FOOTWEAR": "Chaussures",
        "SOYBEANS": "Soja", "NICKEL": "Nickel", "ALUMINIUM": "Aluminium"
      };

      // Country flags
      const COUNTRY_FLAGS = {
        "AE": "üá¶üá™", "AR": "üá¶üá∑", "AU": "üá¶üá∫", "BE": "üáßüá™", "BO": "üáßüá¥", "BR": "üáßüá∑",
        "CA": "üá®üá¶", "CD": "üá®üá©", "CH": "üá®üá≠", "CL": "üá®üá±", "CN": "üá®üá≥", "DE": "üá©üá™",
        "FI": "üá´üáÆ", "FR": "üá´üá∑", "GB": "üá¨üáß", "GN": "üá¨üá≥", "HK": "üá≠üá∞", "ID": "üáÆüá©",
        "IN": "üáÆüá≥", "KR": "üá∞üá∑", "KZ": "üá∞üáø", "LU": "üá±üá∫", "MX": "üá≤üáΩ", "MY": "üá≤üáæ",
        "NA": "üá≥üá¶", "NG": "üá≥üá¨", "NL": "üá≥üá±", "NO": "üá≥üá¥", "PK": "üáµüá∞", "PE": "üáµüá™",
        "PH": "üáµüá≠", "QA": "üá∂üá¶", "RU": "üá∑üá∫", "SE": "üá∏üá™", "SG": "üá∏üá¨", "TH": "üáπüá≠",
        "UA": "üá∫üá¶", "US": "üá∫üá∏", "VN": "üáªüá≥", "ZA": "üáøüá¶", "ZM": "üáøüá≤"
      };

      // üîß COULEURS AVEC NORMALISATION D'ACCENTS
      const labelColors = {
        positive: 'text-green-400',
        neutral:  'text-gray-400',
        negative: 'text-red-400'
      };

      const importanceColors = {
        critique: 'text-red-400',
        importante: 'text-yellow-400', 
        g√©n√©rale: 'text-green-400',
        generale: 'text-green-400'  // Fallback sans accent
      };

      // üîß NORMALISATION DES ACCENTS
      function normalizeImportance(value) {
        if (!value) return 'g√©n√©rale';
        const normalized = value.toLowerCase().trim();
        
        // Mapping avec et sans accents
        const mapping = {
          'critique': 'critique',
          'importante': 'importante',
          'g√©n√©rale': 'g√©n√©rale',
          'generale': 'g√©n√©rale',  // Sans accent ‚Üí avec accent
          'general': 'g√©n√©rale',
          'generales': 'g√©n√©rale'
        };
        
        return mapping[normalized] || 'g√©n√©rale';
      }

      function normalizeSentiment(value) {
        if (!value) return 'neutral';
        const normalized = value.toLowerCase().trim();
        
        const mapping = {
          'positive': 'positive',
          'negative': 'negative', 
          'neutral': 'neutral',
          'positif': 'positive',
          'negatif': 'negative',
          'neutre': 'neutral'
        };
        
        return mapping[normalized] || 'neutral';
      }

      // üîß DEBUG avec normalisation et corr√©lations
      function updateDebugInfo() {
        const debug = document.getElementById('debugInfo');
        if (!rows.length) {
          debug.textContent = 'Aucune donn√©e charg√©e';
          return;
        }

        const hasImportance = headers.includes('importance');
        const hasCorrelations = headers.includes('correlations');
        const sentimentDist = {};
        const importanceDist = {};
        let totalCorrelations = 0;
        
        rows.forEach(row => {
          const label = normalizeSentiment(row.label);
          const importance = normalizeImportance(row.importance);
          
          sentimentDist[label] = (sentimentDist[label] || 0) + 1;
          if (hasImportance) {
            importanceDist[importance] = (importanceDist[importance] || 0) + 1;
          }
          if (hasCorrelations && row.correlations) {
            const corrs = row.correlations.split(';').filter(c => c.trim());
            totalCorrelations += corrs.length;
          }
        });

        let text = `üìä ${rows.length} lignes | Sentiment: ${JSON.stringify(sentimentDist)}`;
        if (hasImportance) {
          text += ` | Importance: ${JSON.stringify(importanceDist)}`;
        }
        if (hasCorrelations) {
          text += ` | ${totalCorrelations} corr√©lations`;
        }
        debug.textContent = text;
      }

      const qs = id => document.getElementById(id);
      const fileInput = qs('fileInput');
      const addRowBtn = qs('addRowBtn');
      const validateBtn = qs('validateBtn');
      const downloadBtn = qs('downloadBtn');
      const tableWrapper = qs('tableWrapper');
      const statusSpan = qs('status');
      const statsPanel = qs('statsPanel');

      const ghRepoInp = qs('ghRepo');
      const ghBranchInp = qs('ghBranch');
      const ghTokenInp = qs('ghToken');
      const loadGithubBtn = qs('loadGithubBtn');
      const pushGithubBtn = qs('pushGithubBtn');
      const triggerWorkflowBtn = qs('triggerWorkflowBtn');
      const ghStatus = qs('ghStatus');

      const validationResults = qs('validationResults');
      const validationContent = qs('validationContent');

      let headers = [];
      let rows = [];
      let currentFilename = '';
      let currentSha = null;

      // Fonction pour cr√©er le dropdown de corr√©lations
      function createCorrelationDropdown(rowIndex) {
        const currentCorrelations = (rows[rowIndex].correlations || '').split(';').filter(c => c.trim());
        
        let dropdownHtml = `
          <div class="correlation-dropdown" data-row="${rowIndex}">
            <button class="correlation-dropdown-button" onclick="toggleCorrelationDropdown(${rowIndex})">
              üìä S√©lectionner corr√©lations (${currentCorrelations.length})
            </button>
            <div class="correlation-dropdown-content">
              <div class="p-2 border-b border-gray-700">
                <input type="text" placeholder="Rechercher..." class="w-full px-2 py-1 bg-black/20 text-white text-sm rounded" onkeyup="filterCorrelations(${rowIndex}, this.value)">
              </div>
        `;
        
        ALL_CORRELATIONS.forEach(corr => {
          const [country, product] = corr.split(':');
          const flag = COUNTRY_FLAGS[country] || 'üåç';
          const productLabel = PRODUCT_LABELS[product] || product;
          const isChecked = currentCorrelations.includes(corr);
          
          dropdownHtml += `
            <div class="correlation-option ${isChecked ? 'selected' : ''}" data-correlation="${corr}">
              <input type="checkbox" class="correlation-checkbox" 
                     ${isChecked ? 'checked' : ''} 
                     onchange="updateCorrelation(${rowIndex}, '${corr}', this.checked)">
              <span class="text-sm text-gray-200">${flag} ${country}: ${productLabel}</span>
            </div>
          `;
        });
        
        dropdownHtml += `</div></div>`;
        return dropdownHtml;
      }

      // Toggle dropdown
      window.toggleCorrelationDropdown = function(rowIndex) {
        const dropdown = document.querySelector(`.correlation-dropdown[data-row="${rowIndex}"]`);
        dropdown.classList.toggle('active');
        
        // Fermer les autres dropdowns
        document.querySelectorAll('.correlation-dropdown').forEach(d => {
          if (d !== dropdown) d.classList.remove('active');
        });
      };

      // Filter correlations
      window.filterCorrelations = function(rowIndex, searchTerm) {
        const dropdown = document.querySelector(`.correlation-dropdown[data-row="${rowIndex}"]`);
        const options = dropdown.querySelectorAll('.correlation-option');
        
        options.forEach(option => {
          const text = option.textContent.toLowerCase();
          if (text.includes(searchTerm.toLowerCase())) {
            option.style.display = 'flex';
          } else {
            option.style.display = 'none';
          }
        });
      };

      // Update correlation
      window.updateCorrelation = function(rowIndex, correlation, isChecked) {
        const currentCorrelations = (rows[rowIndex].correlations || '').split(';').filter(c => c.trim());
        
        if (isChecked) {
          if (!currentCorrelations.includes(correlation)) {
            currentCorrelations.push(correlation);
          }
        } else {
          const index = currentCorrelations.indexOf(correlation);
          if (index > -1) {
            currentCorrelations.splice(index, 1);
          }
        }
        
        rows[rowIndex].correlations = currentCorrelations.join(';');
        
        // Update visual state
        const option = document.querySelector(`.correlation-dropdown[data-row="${rowIndex}"] .correlation-option[data-correlation="${correlation}"]`);
        if (option) {
          option.classList.toggle('selected', isChecked);
        }
        
        // Update button text
        const button = document.querySelector(`.correlation-dropdown[data-row="${rowIndex}"] .correlation-dropdown-button`);
        if (button) {
          button.textContent = `üìä S√©lectionner corr√©lations (${currentCorrelations.length})`;
        }
        
        updateStats();
        statusSpan.textContent = `Ligne ${rowIndex + 1}: corr√©lations mises √† jour`;
      };

      // Clear all correlations
      window.clearCorrelations = function(rowIndex) {
        rows[rowIndex].correlations = '';

        // d√©coche toutes les cases du dropdown de cette ligne
        const dropdown = document.querySelector(`.correlation-dropdown[data-row="${rowIndex}"]`);
        if (dropdown) {
          dropdown.querySelectorAll('.correlation-checkbox').forEach(cb => cb.checked = false);
          dropdown.querySelectorAll('.correlation-option').forEach(opt => opt.classList.remove('selected'));
          const btn = dropdown.querySelector('.correlation-dropdown-button');
          if (btn) btn.textContent = `üìä S√©lectionner corr√©lations (0)`;
        }

        updateStats();
        statusSpan.textContent = `Ligne ${rowIndex + 1}: corr√©lations vid√©es`;
      };

      // Close dropdowns when clicking outside
      document.addEventListener('click', function(event) {
        if (!event.target.closest('.correlation-dropdown')) {
          document.querySelectorAll('.correlation-dropdown').forEach(d => {
            d.classList.remove('active');
          });
        }
      });

      // üîß VALIDATION avec normalisation et corr√©lations
      function validateDataset() {
        const issues = [];
        const stats = { positive: 0, negative: 0, neutral: 0, invalid_sentiment: 0 };
        const importanceStats = { critique: 0, importante: 0, g√©n√©rale: 0, invalid_importance: 0 };
        const correlationStats = { total: 0, unique: new Set(), byCountry: {} };
        
        const requiredHeaders = ['text', 'label'];
        const hasImportance = headers.includes('importance');
        const hasCorrelations = headers.includes('correlations');
        
        if (hasImportance) requiredHeaders.push('importance');
        
        for (const header of requiredHeaders) {
          if (!headers.includes(header)) {
            issues.push(`‚ùå Colonne "${header}" requise`);
          }
        }
        
        rows.forEach((row, idx) => {
          if (!row.text || row.text.trim().length < 10) {
            issues.push(`‚ö†Ô∏è Ligne ${idx + 1}: texte trop court`);
          }
          
          // Sentiment avec normalisation
          const label = normalizeSentiment(row.label);
          const validSentiments = ['positive', 'negative', 'neutral'];
          if (validSentiments.includes(label)) {
            stats[label]++;
          } else {
            stats.invalid_sentiment++;
            issues.push(`‚ùå Ligne ${idx + 1}: sentiment "${row.label}" invalide`);
          }
          
          // Importance avec normalisation
          if (hasImportance) {
            const importance = normalizeImportance(row.importance);
            const validImportance = ['critique', 'importante', 'g√©n√©rale'];
            if (validImportance.includes(importance)) {
              importanceStats[importance]++;
            } else {
              importanceStats.invalid_importance++;
              issues.push(`‚ùå Ligne ${idx + 1}: importance "${row.importance}" invalide`);
            }
          }
          
          // Corr√©lations
          if (hasCorrelations && row.correlations) {
            const corrs = row.correlations.split(';').filter(c => c.trim());
            correlationStats.total += corrs.length;
            corrs.forEach(corr => {
              correlationStats.unique.add(corr);
              const [country] = corr.split(':');
              if (country) {
                correlationStats.byCountry[country] = (correlationStats.byCountry[country] || 0) + 1;
              }
            });
          }
        });
        
        // Affichage
        let html = `<div class="grid md:grid-cols-2 gap-4">`;
        html += `<div>`;
        html += `<h4 class="font-medium text-white mb-2">üìä Statistiques</h4>`;
        html += `<ul class="space-y-1 text-sm">`;
        html += `<li>Total: ${rows.length} √©chantillons</li>`;
        html += `<li><strong>Sentiment:</strong></li>`;
        html += `<li>‚Ä¢ Positifs: ${stats.positive} (${Math.round(stats.positive/rows.length*100)}%)</li>`;
        html += `<li>‚Ä¢ N√©gatifs: ${stats.negative} (${Math.round(stats.negative/rows.length*100)}%)</li>`;
        html += `<li>‚Ä¢ Neutres: ${stats.neutral} (${Math.round(stats.neutral/rows.length*100)}%)</li>`;
        if (stats.invalid_sentiment > 0) html += `<li class="text-red-400">‚Ä¢ Invalides: ${stats.invalid_sentiment}</li>`;
        
        if (hasImportance) {
          html += `<li><strong>Importance:</strong></li>`;
          html += `<li>‚Ä¢ Critiques: ${importanceStats.critique} (${Math.round(importanceStats.critique/rows.length*100)}%)</li>`;
          html += `<li>‚Ä¢ Importantes: ${importanceStats.importante} (${Math.round(importanceStats.importante/rows.length*100)}%)</li>`;
          html += `<li>‚Ä¢ G√©n√©rales: ${importanceStats.g√©n√©rale} (${Math.round(importanceStats.g√©n√©rale/rows.length*100)}%)</li>`;
          if (importanceStats.invalid_importance > 0) html += `<li class="text-red-400">‚Ä¢ Invalides: ${importanceStats.invalid_importance}</li>`;
        }
        
        if (hasCorrelations) {
          html += `<li><strong>Corr√©lations:</strong></li>`;
          html += `<li>‚Ä¢ Total: ${correlationStats.total}</li>`;
          html += `<li>‚Ä¢ Uniques: ${correlationStats.unique.size}</li>`;
          html += `<li>‚Ä¢ Top pays: ${Object.entries(correlationStats.byCountry).sort((a,b) => b[1] - a[1]).slice(0,3).map(([c,n]) => `${c}(${n})`).join(', ')}</li>`;
        }
        
        html += `</ul></div>`;
        
        html += `<div>`;
        html += `<h4 class="font-medium text-white mb-2">${issues.length ? '‚ö†Ô∏è' : '‚úÖ'} Validation</h4>`;
        if (issues.length) {
          html += `<ul class="space-y-1 text-sm">${issues.map(i => `<li>${i}</li>`).join('')}</ul>`;
        } else {
          html += `<p class="text-green-400">‚úÖ Dataset valide !</p>`;
        }
        html += `</div></div>`;
        
        validationContent.innerHTML = html;
        validationResults.classList.remove('hidden');
        
        return issues.length === 0;
      }

      // üîß STATS avec normalisation et corr√©lations
      function updateStats() {
        if (!rows.length) return;
        
        const sentimentStats = { positive: 0, negative: 0, neutral: 0 };
        const importanceStats = { critique: 0, importante: 0, g√©n√©rale: 0 };
        let totalCorrelations = 0;
        
        rows.forEach(row => {
          const label = normalizeSentiment(row.label);
          const importance = normalizeImportance(row.importance);
          
          if (sentimentStats.hasOwnProperty(label)) sentimentStats[label]++;
          if (importanceStats.hasOwnProperty(importance)) importanceStats[importance]++;
          
          if (row.correlations) {
            const corrs = row.correlations.split(';').filter(c => c.trim());
            totalCorrelations += corrs.length;
          }
        });
        
        qs('totalRows').textContent = rows.length;
        qs('positiveCount').textContent = sentimentStats.positive;
        qs('negativeCount').textContent = sentimentStats.negative;
        qs('neutralCount').textContent = sentimentStats.neutral;
        
        qs('critiqueCount').textContent = importanceStats.critique;
        qs('importanteCount').textContent = importanceStats.importante;
        qs('g√©n√©raleCount').textContent = importanceStats.g√©n√©rale;
        
        qs('correlationCount').textContent = totalCorrelations;
        
        statsPanel.classList.remove('hidden');
        updateDebugInfo();
      }

      // üîß RENDU avec normalisation et corr√©lations
      function renderTable() {
        if (!headers.length) return;

        let html = `
          <table class="min-w-full divide-y divide-white/20 text-sm">
            <thead class="bg-white/10">
              <tr>
                ${headers.map(h =>
                  `<th class="px-4 py-3 text-left font-medium uppercase text-gray-200">${h}</th>`
                ).join('')}
                <th class="px-4 py-3 text-left font-medium uppercase text-gray-200">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-white/10">
        `;

        rows.forEach((row, rIdx) => {
          html += `<tr class="hover:bg-white/5 transition-colors">`;

          headers.forEach(h => {
            if (h === 'label') {
              const val = normalizeSentiment(row.label);
              const color = labelColors[val] || 'text-gray-400';

              html += `
                <td class="px-4 py-3 ${color}">
                  <select data-row="${rIdx}" data-type="label"
                          class="bg-transparent outline-none ${color} font-bold">
                    <option value="positive" ${val==='positive'?'selected':''}>positive</option>
                    <option value="neutral"  ${val==='neutral'?'selected':''}>neutral</option>
                    <option value="negative" ${val==='negative'?'selected':''}>negative</option>
                  </select>
                </td>`;
            } else if (h === 'importance') {
              const val = normalizeImportance(row.importance);
              const color = importanceColors[val] || 'text-gray-400';
              
              html += `
                <td class="px-4 py-3 ${color}">
                  <select data-row="${rIdx}" data-type="importance"
                          class="bg-transparent outline-none ${color} font-bold">
                    <option value="critique" ${val==='critique'?'selected':''}>critique</option>
                    <option value="importante" ${val==='importante'?'selected':''}>importante</option>
                    <option value="g√©n√©rale" ${val==='g√©n√©rale'?'selected':''}>g√©n√©rale</option>
                  </select>
                </td>`;
            } else if (h === 'correlations') {
              const corrs = (row.correlations || '').split(';').filter(c => c.trim());
              html += `
                <td class="px-4 py-3">
                  <div class="flex items-center gap-3">
                    ${createCorrelationDropdown(rIdx)}
                    <span class="text-xs text-purple-300">${corrs.length} s√©lection(s)</span>
                    <button title="Vider"
                            class="text-slate-400 hover:text-red-400 transition"
                            onclick="clearCorrelations(${rIdx})">üóëÔ∏è</button>
                  </div>
                </td>`;
            } else {
              html += `
                <td contenteditable="true"
                    data-row="${rIdx}" data-col="${h}"
                    class="px-4 py-3 whitespace-pre-wrap focus:outline-none focus:bg-white/10 text-gray-200 rounded transition-colors">
                    ${row[h] ?? ''}
                </td>`;
            }
          });

          html += `
            <td class="px-4 py-3">
              <button onclick="deleteRow(${rIdx})"
                      class="text-red-400 hover:text-red-300 transition-colors">üóëÔ∏è</button>
            </td>
          </tr>`;
        });

        html += `</tbody></table>`;
        tableWrapper.innerHTML = html;

        // üîß LISTENERS avec normalisation
        tableWrapper.querySelectorAll('td[contenteditable=true]').forEach(cell => {
          cell.addEventListener('input', () => {
            const r = +cell.dataset.row, c = cell.dataset.col;
            rows[r][c] = cell.innerText.trim();
            updateStats();
            statusSpan.textContent = `Ligne ${r + 1} modifi√©e‚Ä¶`;
          });
        });

        tableWrapper.querySelectorAll('select[data-type]').forEach(sel => {
          sel.addEventListener('change', () => {
            const r = +sel.dataset.row;
            const type = sel.dataset.type;
            const newValue = sel.value;
            
            if (type === 'importance') {
              rows[r].importance = newValue;
              const normalized = normalizeImportance(newValue);
              const colors = Object.values(importanceColors);
              sel.classList.remove(...colors);
              sel.parentElement.classList.remove(...colors);
              
              const newColor = importanceColors[normalized];
              sel.classList.add(newColor);
              sel.parentElement.classList.add(newColor);
              
              statusSpan.textContent = `Ligne ${r + 1}: importance ‚ûú ${newValue}`;
            } else {
              rows[r].label = newValue;
              const normalized = normalizeSentiment(newValue);
              const colors = Object.values(labelColors);
              sel.classList.remove(...colors);
              sel.parentElement.classList.remove(...colors);
              
              const newColor = labelColors[normalized];
              sel.classList.add(newColor);
              sel.parentElement.classList.add(newColor);
              
              statusSpan.textContent = `Ligne ${r + 1}: sentiment ‚ûú ${newValue}`;
            }
            
            updateStats();
          });
        });

        updateStats();
      }

      function deleteRow(index) {
        rows.splice(index, 1);
        renderTable();
        statusSpan.textContent = `Ligne supprim√©e`;
      }

      function enableLocalBtns() { 
        addRowBtn.disabled = false; 
        validateBtn.disabled = false;
        downloadBtn.disabled = false; 
        pushGithubBtn.disabled = false;
        triggerWorkflowBtn.disabled = false;
      }

      // √âV√âNEMENTS
      fileInput.addEventListener('change', e => {
        if (e.target.files.length) parseCsvFile(e.target.files[0]);
      });

      function parseCsvFile(file) {
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: res => {
            headers = res.meta.fields; 
            rows = res.data;
            
            // üîß Nettoyage avec normalisation
            rows = rows.map(row => {
              if (!row.importance && headers.includes('importance')) {
                row.importance = 'g√©n√©rale';
              } else if (row.importance) {
                row.importance = normalizeImportance(row.importance);
              }
              if (!row.label) {
                row.label = 'neutral';
              } else {
                row.label = normalizeSentiment(row.label);
              }
              // Assurer que correlations existe
              if (!row.correlations && headers.includes('correlations')) {
                row.correlations = '';
              }
              return row;
            });
            
            currentFilename = file.name; 
            currentSha = null;
            renderTable(); 
            enableLocalBtns();
            statusSpan.textContent = `${rows.length} lignes depuis ${file.name}`;
            validationResults.classList.add('hidden');
          },
          error: err => {
            statusSpan.textContent = 'Erreur CSV: ' + err;
            console.error(err);
          }
        });
      }

      addRowBtn.addEventListener('click', () => {
        const obj = {}; 
        headers.forEach(h => {
          if (h === 'label') obj[h] = 'neutral';
          else if (h === 'importance') obj[h] = 'g√©n√©rale';
          else if (h === 'correlations') obj[h] = '';
          else obj[h] = '';
        }); 
        rows.push(obj);
        renderTable(); 
        statusSpan.textContent = `Ligne ajout√©e (#${rows.length})`;
      });

      validateBtn.addEventListener('click', () => {
        const isValid = validateDataset();
        statusSpan.textContent = isValid ? '‚úÖ Dataset valid√©' : '‚ö†Ô∏è Erreurs d√©tect√©es';
      });

      downloadBtn.addEventListener('click', () => {
        const csv = Papa.unparse(rows, { columns: headers });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const name = currentFilename || `news_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.csv`;
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); 
        a.href = url; 
        a.download = name; 
        document.body.appendChild(a); 
        a.click(); 
        document.body.removeChild(a); 
        URL.revokeObjectURL(url);
        statusSpan.textContent = 'CSV t√©l√©charg√© ‚úîÔ∏è';
      });

      // GitHub helpers
      async function githubRequest(path, method='GET', body=null) {
        const token = ghTokenInp.value.trim();
        const repo = ghRepoInp.value.trim();
        if (!token || !repo) throw new Error('Token ou repo manquant');
        
        const res = await fetch(`https://api.github.com/repos/${repo}/${path}`, {
          method,
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github+json',
            'X-GitHub-Api-Version': '2022-11-28'
          },
          body: body ? JSON.stringify(body) : null
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          throw new Error(`GitHub ${method} ${path} ‚Üí ${res.status}: ${errorData.message || 'Erreur inconnue'}`);
        }
        return res.json();
      }

      loadGithubBtn.addEventListener('click', async () => {
        try {
          ghStatus.textContent = 'üîç Recherche du dernier fichier...';
          const branch = ghBranchInp.value.trim() || 'main';
          const files = await githubRequest(`contents/datasets?ref=${branch}`);
          
          const csvFiles = files.filter(f => f.type === 'file' && /\.csv$/.test(f.name));
          if (!csvFiles.length) throw new Error('Aucun fichier CSV trouv√© dans datasets/');
          
          csvFiles.sort((a,b) => b.name.localeCompare(a.name));
          const latest = csvFiles[0];
          
          currentFilename = latest.name; 
          currentSha = latest.sha;
          ghStatus.textContent = `üì• Chargement ${latest.name}...`;
          
          const contentObj = await githubRequest(`contents/datasets/${latest.name}?ref=${branch}`);
          const csvText = atob(contentObj.content.replace(/\n/g, ''));
          
          const res = Papa.parse(csvText, { header: true, skipEmptyLines: true });
          headers = res.meta.fields; 
          rows = res.data;
          
          // üîß Nettoyage GitHub avec normalisation
          rows = rows.map(row => {
            if (!row.importance && headers.includes('importance')) {
              row.importance = 'g√©n√©rale';
            } else if (row.importance) {
              row.importance = normalizeImportance(row.importance);
            }
            if (!row.label) {
              row.label = 'neutral';
            } else {
              row.label = normalizeSentiment(row.label);
            }
            if (!row.correlations && headers.includes('correlations')) {
              row.correlations = '';
            }
            return row;
          });
          
          renderTable(); 
          enableLocalBtns();
          ghStatus.textContent = `‚úÖ ${rows.length} lignes charg√©es depuis GitHub (${latest.name})`;
          validationResults.classList.add('hidden');
        } catch (err) {
          ghStatus.textContent = '‚ùå Erreur: ' + err.message;
          console.error(err);
        }
      });

      // üîÑ MODIFICATION : Double mise √† jour (fichier actuel + base_reference.csv)
      pushGithubBtn.addEventListener('click', async () => {
        try {
          ghStatus.textContent = 'üì§ Commit en cours...';
          const branch = ghBranchInp.value.trim() || 'main';
          const csv = Papa.unparse(rows, { columns: headers });
          const b64 = btoa(unescape(encodeURIComponent(csv)));
          
          // üîß FIX: Si le fichier n'existe pas encore dans le repo, on lui donne un nom par date
          if (!currentFilename) {
            const today = new Date().toISOString().slice(0,10).replace(/-/g,'');
            currentFilename = `news_${today}.csv`;
          }
          
          // 1Ô∏è‚É£ COMMIT NORMAL du fichier actuel
          const body1 = {
            message: `Update ${currentFilename || 'dataset'} via web editor (${rows.length} lignes)`,
            content: b64,
            branch
          };
          if (currentSha) body1.sha = currentSha;
          
          const res1 = await githubRequest(`contents/datasets/${currentFilename}`, 'PUT', body1);
          currentSha = res1.content.sha;
          ghStatus.textContent = `‚úÖ ${currentFilename} mis √† jour`;
          
          // 2Ô∏è‚É£ FUSION DANS base_reference.csv
          ghStatus.textContent = 'üîÑ Fusion dans base_reference.csv...';
          
          try {
            // R√©cup√©rer base_reference.csv
            const baseObj = await githubRequest(
              `contents/datasets/base_reference.csv?ref=${branch}`
            );
            const baseCSV = atob(baseObj.content.replace(/\n/g, ''));
            const baseRows = Papa.parse(baseCSV, { header: true }).data.map(row => ({
              ...row,
              label: normalizeSentiment(row.label || 'neutral'),
              importance: normalizeImportance(row.importance || 'g√©n√©rale'),
              correlations: row.correlations || ''
            }));
            
            // Fusionner avec d√©duplication sur 'text'
            const map = new Map();
            [...baseRows, ...rows].forEach(r => {
              if (r.text && r.text.trim()) {
                map.set(r.text, r);
              }
            });
            const merged = Array.from(map.values());
            
            // Commit base_reference.csv
            const mergedCSV = Papa.unparse(merged, { columns: headers });
            const body2 = {
              message: `üìù Fusion dans base_reference.csv (+${merged.length - baseRows.length} lignes depuis ${currentFilename})`,
              content: btoa(unescape(encodeURIComponent(mergedCSV))),
              sha: baseObj.sha,
              branch
            };
            
            await githubRequest('contents/datasets/base_reference.csv', 'PUT', body2);
            ghStatus.textContent = `‚úÖ Tout mis √† jour! ${currentFilename} + base_reference.csv (${merged.length} lignes total)`;
            
          } catch (err) {
            // Si base_reference.csv n'existe pas, le cr√©er
            if (err.message.includes('404')) {
              ghStatus.textContent = 'üìù Cr√©ation de base_reference.csv...';
              const body3 = {
                message: `Cr√©ation base_reference.csv depuis ${currentFilename}`,
                content: b64,
                branch
              };
              await githubRequest('contents/datasets/base_reference.csv', 'PUT', body3);
              ghStatus.textContent = `‚úÖ base_reference.csv cr√©√© avec ${rows.length} lignes`;
            } else {
              ghStatus.textContent = `‚ö†Ô∏è ${currentFilename} mis √† jour, mais fusion √©chou√©e: ${err.message}`;
            }
          }
          
        } catch (err) {
          ghStatus.textContent = '‚ùå Erreur: ' + err.message;
          console.error(err);
        }
      });

      triggerWorkflowBtn.addEventListener('click', async () => {
        try {
          ghStatus.textContent = 'üöÄ D√©clenchement du workflow...';
          const branch = ghBranchInp.value.trim() || 'main';
          
          await githubRequest('actions/workflows/finetune-model.yml/dispatches', 'POST', {
            ref: branch,
            inputs: {
              dataset: 'base_reference.csv',  // üîß FIX: Utiliser base_reference.csv au lieu de auto-latest
              model_name: 'yiyanghkust/finbert-tone',
              epochs: '3',
              learning_rate: '2e-5',
              push_to_hub: 'false'
            }
          });
          
          ghStatus.textContent = '‚úÖ Workflow d√©clench√© ! V√©rifiez l\'onglet Actions';
        } catch (err) {
          ghStatus.textContent = '‚ùå Erreur workflow: ' + err.message;
          console.error(err);
        }
      });

      // Initialisation
      document.addEventListener('DOMContentLoaded', () => {
        ghRepoInp.value = 'Bencode92/tradepulse-ml';
        updateDebugInfo();
        console.log('üîß HTML avec r√©duction des corr√©lations de 83 √† 59');
      });
    </script>
  </body>
</html>